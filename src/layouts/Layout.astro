---
import Background from "@/components/background.astro";
import { allBentos } from "@/data/bentos/registry";
import { languages, translations } from "@/i18n/index";
import Footer from "../components/footer.astro";

interface Props {
	title: string;
}

const { title } = Astro.props;
const siteUrl =
	Astro.site?.toString().replace(/\/$/, "") || "https://bentoed.vercel.app";
const description =
	"Browse 30+ free bento grid designs crafted with HTML, CSS, and Tailwind CSS. Copy-paste ready components for galleries, portfolios, blogs, and more.";
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();

const jsonLd = {
	"@context": "https://schema.org",
	"@type": "CollectionPage",
	name: title,
	description: description,
	url: canonicalUrl,
	inLanguage: "en",
	mainEntity: {
		"@type": "ItemList",
		numberOfItems: allBentos.length,
		itemListElement: allBentos.map((bento, i) => ({
			"@type": "ListItem",
			position: i + 1,
			name: bento.meta.name,
			description: bento.meta.description,
		})),
	},
};

const langCodes = languages.map((l) => l.code);
---

<!doctype html>
<html lang="en" data-lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={canonicalUrl} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- hreflang -->
    {langCodes.map((code) => (
      <link rel="alternate" hreflang={code} href={`${canonicalUrl}?lang=${code}`} />
    ))}
    <link rel="alternate" hreflang="x-default" href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={`${siteUrl}/images/tag.jpg`} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={`${siteUrl}/images/tag.jpg`} />

    <!-- JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </head>

  <body>
    <Background />
    <slot />
  </body>

  <!-- i18n Engine -->
  <script is:inline define:vars={{ translations }}>
    window.__i18n = translations;

    function getNestedValue(obj, path) {
      return path.split('.').reduce(function(acc, key) {
        return acc && acc[key];
      }, obj);
    }

    function applyTranslations(lang) {
      var t = window.__i18n[lang] || window.__i18n['en'];
      var elements = document.querySelectorAll('[data-i18n]');
      elements.forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        var value = getNestedValue(t, key);
        if (value) el.textContent = value;
      });

      // Update SEO meta
      var seo = t.seo;
      if (seo) {
        document.title = seo.title;
        var descMeta = document.querySelector('meta[name="description"]');
        if (descMeta) descMeta.setAttribute('content', seo.description);
        var ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) ogTitle.setAttribute('content', seo.title);
        var ogDesc = document.querySelector('meta[property="og:description"]');
        if (ogDesc) ogDesc.setAttribute('content', seo.description);
        var twTitle = document.querySelector('meta[name="twitter:title"]');
        if (twTitle) twTitle.setAttribute('content', seo.title);
        var twDesc = document.querySelector('meta[name="twitter:description"]');
        if (twDesc) twDesc.setAttribute('content', seo.description);
      }
    }

    function initI18n() {
      // Check URL param first, then localStorage
      var urlParams = new URLSearchParams(window.location.search);
      var urlLang = urlParams.get('lang');
      var lang = urlLang || localStorage.getItem('lang') || 'en';

      if (urlLang) localStorage.setItem('lang', urlLang);

      document.documentElement.lang = lang;
      document.documentElement.setAttribute('data-lang', lang);

      if (lang === 'ar') {
        document.documentElement.dir = 'rtl';
      } else {
        document.documentElement.dir = 'ltr';
      }

      applyTranslations(lang);
    }

    // Store for toast usage
    window.__getTranslation = function(key) {
      var lang = localStorage.getItem('lang') || 'en';
      var t = window.__i18n[lang] || window.__i18n['en'];
      return getNestedValue(t, key);
    };

    document.addEventListener('DOMContentLoaded', initI18n);

    window.addEventListener('lang-changed', function(e) {
      applyTranslations(e.detail.lang);
    });
  </script>

  <style is:global>
    :root {
      --color-primary: #131212;
      --color-secondary: #252424;
      --color-tertiary: #ddd;

      --color-block-border: #413f3f1e;
      --color-block-highlight: #3f0303;
      --color-block-highlight-hover: #910707;
    }


    body, body * {
      z-index: 99999;
    }

    .dark {
      --color-primary: #ddd;
      --color-secondary: #888888;
      --color-tertiary: #111111;

      --color-block-border: #ffffff13;
      --color-block-highlight: #868f0b;
      --color-block-highlight-hover: #cfdd11;
    }

    html {
      background-color: var(--color-tertiary);
    }

    /* RTL support */
    [dir="rtl"] {
      text-align: right;
    }
    [dir="rtl"] .flex-row-reverse-rtl {
      flex-direction: row-reverse;
    }
    [dir="rtl"] header .flex {
      flex-direction: row-reverse;
    }
    [dir="rtl"] .ml-1 { margin-left: 0; margin-right: 0.25rem; }
    [dir="rtl"] .ml-3 { margin-left: 0; margin-right: 0.75rem; }
    [dir="rtl"] .mr-3 { margin-right: 0; margin-left: 0.75rem; }
    [dir="rtl"] section { text-align: center; }
  </style>
</html>
